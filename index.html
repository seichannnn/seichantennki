<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天気予報アプリ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (地図用) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- React, ReactDOM, and Lucide Icons via Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- Leaflet JS (地図用) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Babel for transforming JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 背景アニメーション */
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        @keyframes gradient-slow {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animate-blob {
          animation: blob 10s infinite;
        }
        .animate-gradient-slow {
          animation: gradient-slow 20s ease infinite;
        }
        /* カードのスタイル */
        .glass-card {
           background: rgba(255, 255, 255, 0.4);
           box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
           backdrop-filter: blur(12px);
           -webkit-backdrop-filter: blur(12px);
           border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .text-glow {
            text-shadow: 0 0 10px rgba(255,255,255,0.7);
        }
        /* スクロールバー非表示（横スクロール用） */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Leaflet地図のスタイル */
        .leaflet-container {
            background: rgba(255, 255, 255, 0.5) !important;
            font-family: sans-serif;
            z-index: 0;
        }
        /* レンジスライダー */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            position: relative;
            z-index: 20;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent;
            border-radius: 2px;
        }
        /* トースト通知のアニメーション */
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Wind, MapPin, Calendar, Sun, Cloud, CloudRain, CloudSnow, CloudLightning, CloudFog, Loader2, Thermometer, LocateFixed, Droplets, User, Star, X, Sparkles, Map as MapIcon, CloudRain as RadarIcon, Play, Pause, Umbrella, Sunrise, Sunset, Clock, ArrowUp, ArrowDown, AlertTriangle, Share2, Check } from 'lucide-react';

        // 雨雲レーダーコンポーネント
        const RadarMap = ({ lat, lon }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const radarLayerRef = useRef(null);
            
            const [frames, setFrames] = useState([]); 
            const [currentFrameIndex, setCurrentFrameIndex] = useState(0);
            const [pastCount, setPastCount] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [apiHost, setApiHost] = useState('https://tile.cache.rainviewer.com');
            const [isForecast, setIsForecast] = useState(false);

            useEffect(() => {
                if (!mapRef.current) return;

                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current, {
                        center: [lat, lon],
                        zoom: 8,
                        zoomControl: false,
                        attributionControl: false
                    });

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        opacity: 0.6,
                    }).addTo(mapInstanceRef.current);
                    
                    L.control.attribution({
                        position: 'bottomright',
                        prefix: false
                    }).addAttribution('&copy; OSM, RainViewer').addTo(mapInstanceRef.current);

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #3b82f6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px #3b82f6;"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    L.marker([lat, lon], { icon }).addTo(mapInstanceRef.current);
                } else {
                    mapInstanceRef.current.setView([lat, lon], 8);
                }
                
                setTimeout(() => {
                    if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                }, 100);

            }, [lat, lon]);

            useEffect(() => {
                const fetchRadar = async () => {
                    try {
                        const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                        const data = await response.json();
                        
                        const pastData = data.radar.past || [];
                        const nowcastData = data.radar.nowcast || [];
                        const allFrames = [...pastData, ...nowcastData];
                        
                        setFrames(allFrames);
                        setPastCount(pastData.length);
                        if (data.host) setApiHost(data.host);

                        if (pastData.length > 0) {
                            setCurrentFrameIndex(pastData.length - 1);
                        } else {
                            setCurrentFrameIndex(0);
                        }

                    } catch (error) {
                        console.error("Radar fetch error:", error);
                    }
                };

                fetchRadar();
            }, []);

            useEffect(() => {
                if (!mapInstanceRef.current || frames.length === 0) return;

                const frame = frames[currentFrameIndex];
                if (!frame) return;

                const isFuture = currentFrameIndex >= pastCount;
                setIsForecast(isFuture);

                if (radarLayerRef.current) {
                    mapInstanceRef.current.removeLayer(radarLayerRef.current);
                }

                radarLayerRef.current = L.tileLayer(`${apiHost}${frame.path}/256/{z}/{x}/{y}/6/1_1.png`, {
                    opacity: 0.8,
                    zIndex: 100
                }).addTo(mapInstanceRef.current);

            }, [currentFrameIndex, frames, apiHost, pastCount]);

            useEffect(() => {
                let intervalId;
                if (isPlaying && frames.length > 0) {
                    intervalId = setInterval(() => {
                        setCurrentFrameIndex((prevIndex) => {
                            return (prevIndex + 1) % frames.length;
                        });
                    }, 500);
                }
                return () => clearInterval(intervalId);
            }, [isPlaying, frames.length]);

            const formatTime = (timestamp) => {
                const date = new Date(timestamp * 1000);
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            const togglePlay = () => setIsPlaying(!isPlaying);

            const handleSliderChange = (e) => {
                setIsPlaying(false);
                setCurrentFrameIndex(Number(e.target.value));
            };

            const nowPositionPercent = frames.length > 1 ? ((pastCount - 1) / (frames.length - 1)) * 100 : 0;

            return (
                <div className="w-full h-full flex flex-col relative rounded-3xl overflow-hidden bg-white/30 border border-white/20">
                    <div className="flex-1 relative min-h-[400px]">
                        <div ref={mapRef} className="absolute inset-0 w-full h-full z-0" />
                    </div>
                    
                    <div className="bg-white/90 backdrop-blur-md p-3 border-t border-gray-200/50 z-10 relative">
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center space-x-3">
                                <button 
                                    onClick={togglePlay}
                                    className="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors shadow-md active:scale-95"
                                >
                                    {isPlaying ? <Pause className="w-4 h-4 fill-current" /> : <Play className="w-4 h-4 fill-current ml-0.5" />}
                                </button>
                                <div className="text-base font-bold text-gray-700 w-36 tabular-nums">
                                    {frames.length > 0 && formatTime(frames[currentFrameIndex].time)}
                                    {isForecast ? (
                                        <span className="text-xs text-blue-500 ml-2 font-normal bg-blue-100 px-2 py-0.5 rounded-full">予報</span>
                                    ) : (
                                        currentFrameIndex === pastCount - 1 && <span className="text-xs text-green-600 ml-2 font-normal bg-green-100 px-2 py-0.5 rounded-full">現在</span>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        <div className="relative w-full h-8 flex items-center px-1">
                            {frames.length > 0 && (
                                <div 
                                    className="absolute top-1 bottom-1 w-0.5 bg-green-500/50 z-0 pointer-events-none"
                                    style={{ left: `${nowPositionPercent}%` }}
                                ></div>
                            )}
                            
                            <input 
                                type="range" 
                                min="0" 
                                max={frames.length - 1} 
                                value={currentFrameIndex} 
                                onChange={handleSliderChange}
                                className="w-full h-2 rounded-lg appearance-none cursor-pointer z-10 relative"
                                style={{
                                    background: `linear-gradient(to right, #94a3b8 0%, #94a3b8 ${nowPositionPercent}%, #cbd5e1 ${nowPositionPercent}%, #cbd5e1 100%)`
                                }}
                            />
                        </div>

                        <div className="relative h-4 text-[10px] text-gray-500 w-full mt-[-2px] font-medium">
                            <span className="absolute left-0 top-0">過去</span>
                            {frames.length > 0 && (
                                <span 
                                    className="absolute transform -translate-x-1/2 text-green-600 font-bold top-0"
                                    style={{ left: `${nowPositionPercent}%` }}
                                >
                                    現在
                                </span>
                            )}
                            <span className="absolute right-0 top-0">未来</span>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [city, setCity] = useState('東京');
            const [weatherData, setWeatherData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [favorites, setFavorites] = useState([]);
            const [viewMode, setViewMode] = useState('weather');
            const [coords, setCoords] = useState({ lat: 35.6895, lon: 139.6917 });
            const [shareToast, setShareToast] = useState(false);

            const getWeatherIcon = (code) => {
                if (code === 0) return { icon: <Sun className="w-full h-full text-yellow-300 animate-spin-slow drop-shadow-md" />, label: '快晴', bg: 'from-orange-400 via-amber-300 to-yellow-200', text: 'text-yellow-100', accent: 'bg-yellow-400/30' };
                if (code >= 1 && code <= 3) return { icon: <Cloud className="w-full h-full text-white drop-shadow-md" />, label: '晴れ/曇り', bg: 'from-blue-400 via-sky-300 to-indigo-100', text: 'text-white', accent: 'bg-white/20' };
                if (code >= 45 && code <= 48) return { icon: <CloudFog className="w-full h-full text-gray-100 drop-shadow-md" />, label: '霧', bg: 'from-gray-600 via-slate-400 to-gray-200', text: 'text-gray-100', accent: 'bg-gray-400/30' };
                if (code >= 51 && code <= 67) return { icon: <CloudRain className="w-full h-full text-blue-200 drop-shadow-md" />, label: '雨', bg: 'from-blue-800 via-blue-600 to-cyan-500', text: 'text-blue-100', accent: 'bg-blue-500/30' };
                if (code >= 71 && code <= 77) return { icon: <CloudSnow className="w-full h-full text-white drop-shadow-md" />, label: '雪', bg: 'from-indigo-500 via-purple-400 to-pink-200', text: 'text-white', accent: 'bg-white/20' };
                if (code >= 80 && code <= 82) return { icon: <CloudRain className="w-full h-full text-blue-300 drop-shadow-md" />, label: 'にわか雨', bg: 'from-sky-700 via-blue-500 to-sky-300', text: 'text-sky-100', accent: 'bg-sky-400/30' };
                if (code >= 85 && code <= 86) return { icon: <CloudSnow className="w-full h-full text-white drop-shadow-md" />, label: '雪', bg: 'from-gray-500 via-gray-300 to-white', text: 'text-gray-100', accent: 'bg-gray-400/30' };
                if (code >= 95 && code <= 99) return { icon: <CloudLightning className="w-full h-full text-yellow-300 drop-shadow-md" />, label: '雷雨', bg: 'from-slate-900 via-purple-900 to-slate-700', text: 'text-yellow-200', accent: 'bg-yellow-500/20' };
                
                return { icon: <Cloud className="w-full h-full text-gray-200" />, label: '不明', text: 'text-white' };
            };

            // ⚠️ 気象情報を判定する関数
            const getWeatherAlerts = (current) => {
                if (!current) return [];
                const alerts = [];
                const { weathercode, windspeed, temperature } = current;

                if (weathercode === 45 || weathercode === 48) {
                    alerts.push({ level: 'caution', message: '濃霧注意: 視界が悪くなっています', color: 'bg-gray-600/80' });
                }
                if (weathercode >= 95) {
                    alerts.push({ level: 'warning', message: '雷注意: 落雷や突風に警戒してください', color: 'bg-yellow-600/80' });
                }
                if (weathercode === 65 || weathercode === 67 || weathercode === 81 || weathercode === 82) {
                    alerts.push({ level: 'warning', message: '大雨注意: 激しい雨が降っています', color: 'bg-blue-700/80' });
                }
                if (weathercode === 75 || weathercode === 77 || weathercode === 85 || weathercode === 86) {
                    alerts.push({ level: 'warning', message: '大雪注意: 積雪や路面凍結に注意', color: 'bg-cyan-700/80' });
                }
                if (windspeed >= 40) {
                    alerts.push({ level: 'caution', message: '強風注意: 風が強くなっています', color: 'bg-orange-600/80' });
                }
                if (temperature >= 35) {
                    alerts.push({ level: 'warning', message: '猛暑警戒: 熱中症に十分注意してください', color: 'bg-red-600/80' });
                }
                if (temperature <= 0) {
                    alerts.push({ level: 'caution', message: '凍結注意: 路面の凍結に注意してください', color: 'bg-sky-600/80' });
                }

                return alerts;
            };

            const fetchWeather = async (cityName) => {
                setLoading(true);
                setError(null);
                try {
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=ja&format=json`;
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();
            
                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error('見つかりませんでした');
                }
            
                const { latitude, longitude, name } = geoData.results[0];
                await fetchWeatherCommon(latitude, longitude, name);
            
                } catch (err) {
                setError(err.message);
                setLoading(false);
                }
            };

            const fetchWeatherByCoords = async (latitude, longitude) => {
                setLoading(true);
                setError(null);
                try {
                let cityName = '現在地';
                try {
                    const geoRes = await fetch(
                    `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=ja`
                    );
                    const geoData = await geoRes.json();
                    cityName = geoData.city || geoData.locality || geoData.principalSubdivision || '現在地';
                } catch (e) {
                    console.warn("地名取得失敗:", e);
                }
                await fetchWeatherCommon(latitude, longitude, cityName);
                } catch (err) {
                setError('天気の取得に失敗しました');
                setLoading(false);
                }
            };

            const fetchWeatherCommon = async (latitude, longitude, cityName) => {
                try {
                setCoords({ lat: latitude, lon: longitude });

                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset&timezone=auto`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                if (weatherData.error) {
                    throw new Error("API Error: " + weatherData.reason);
                }

                const currentTimeStr = weatherData.current.time;
                const currentHourStr = currentTimeStr.slice(0, 13);

                const hourlyIndex = weatherData.hourly.time.findIndex(t => t.startsWith(currentHourStr));
                const startIndex = hourlyIndex !== -1 ? hourlyIndex : 0;
                
                const hourlySlice = {
                    time: weatherData.hourly.time.slice(startIndex, startIndex + 24),
                    temperature: weatherData.hourly.temperature_2m.slice(startIndex, startIndex + 24),
                    weathercode: weatherData.hourly.weather_code.slice(startIndex, startIndex + 24),
                    precipitation: weatherData.hourly.precipitation_probability.slice(startIndex, startIndex + 24),
                };

                setWeatherData({
                    city: cityName,
                    current: {
                        time: weatherData.current.time,
                        weathercode: weatherData.current.weather_code,
                        temperature: weatherData.current.temperature_2m,
                        windspeed: weatherData.current.wind_speed_10m,
                        humidity: weatherData.current.relative_humidity_2m,
                        apparent_temp: weatherData.current.apparent_temperature
                    },
                    daily: weatherData.daily,
                    hourly: hourlySlice,
                });
                setCity(cityName);
                
                localStorage.setItem('weatherAppLastCity', cityName);
                } catch (err) {
                    console.error(err);
                    setError("天気情報の取得に失敗しました");
                } finally {
                    setLoading(false);
                }
            };

            const handleCurrentLocation = () => {
                if (!navigator.geolocation) {
                setError('お使いのブラウザは位置情報をサポートしていません');
                return;
                }

                setLoading(true);
                navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    fetchWeatherByCoords(latitude, longitude);
                },
                (err) => {
                    setLoading(false);
                    setError('位置情報の取得に失敗しました。許可されているか確認してください。');
                }
                );
            };

            // URLパラメータのチェック
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const cityParam = params.get('city');

                if (cityParam) {
                    fetchWeather(cityParam);
                } else {
                    const savedCity = localStorage.getItem('weatherAppLastCity');
                    fetchWeather(savedCity || 'Tokyo');
                }

                const savedFavorites = localStorage.getItem('weatherAppFavorites');
                if (savedFavorites) {
                    setFavorites(JSON.parse(savedFavorites));
                }
            }, []);

            // 共有機能
            const handleShare = () => {
                if (!weatherData) return;
                
                // URLを生成
                const url = new URL(window.location.href);
                url.searchParams.set('city', weatherData.city);
                const shareUrl = url.toString();

                // クリップボードにコピー (iframe対策でexecCommand使用)
                const textArea = document.createElement("textarea");
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setShareToast(true);
                    setTimeout(() => setShareToast(false), 3000); // 3秒後に消える
                } catch (err) {
                    console.error('コピーに失敗しました', err);
                    setError('URLのコピーに失敗しました');
                }
                document.body.removeChild(textArea);
            };

            const toggleFavorite = () => {
                if (!weatherData) return;
                let newFavorites;
                if (favorites.includes(weatherData.city)) {
                newFavorites = favorites.filter(c => c !== weatherData.city);
                } else {
                newFavorites = [...favorites, weatherData.city];
                }
                setFavorites(newFavorites);
                localStorage.setItem('weatherAppFavorites', JSON.stringify(newFavorites));
            };

            const removeFavorite = (e, targetCity) => {
                e.stopPropagation();
                const newFavorites = favorites.filter(c => c !== targetCity);
                setFavorites(newFavorites);
                localStorage.setItem('weatherAppFavorites', JSON.stringify(newFavorites));
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (searchTerm.trim()) {
                fetchWeather(searchTerm);
                setSearchTerm('');
                }
            };

            const formatTimeShort = (isoString) => {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ja-JP', { hour: 'numeric' });
            };

            const formatSunTime = (isoString) => {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            const getTimeBasedGradient = () => {
                if (!weatherData) return 'from-blue-500 to-cyan-400';

                const current = new Date(weatherData.current.time);
                
                const sunrise = new Date(weatherData.daily.sunrise[0]);
                const sunset = new Date(weatherData.daily.sunset[0]);

                const diffSunrise = (current - sunrise) / (1000 * 60); 
                const diffSunset = (current - sunset) / (1000 * 60);

                if (Math.abs(diffSunrise) <= 30) {
                    return 'from-indigo-600 via-purple-500 to-orange-300';
                }
                
                const morningEnd = new Date(current);
                morningEnd.setHours(10, 0, 0, 0);

                if (current > sunrise && current < morningEnd) {
                    return 'from-sky-400 via-cyan-300 to-yellow-100';
                }

                if (Math.abs(diffSunset) <= 60) {
                    return 'from-indigo-900 via-purple-700 to-orange-500';
                }

                if (current > sunset || current < sunrise) {
                    return 'from-slate-900 via-purple-900 to-slate-950';
                }

                return 'from-blue-500 to-cyan-400';
            };

            const bgGradient = getTimeBasedGradient();
            const isFavorite = weatherData && favorites.includes(weatherData.city);
            const currentAlerts = weatherData ? getWeatherAlerts(weatherData.current) : [];

            return (
                <div className={`min-h-screen relative overflow-x-hidden bg-gradient-to-br ${bgGradient} bg-[length:400%_400%] animate-gradient-slow transition-all duration-1000 ease-in-out flex flex-col items-center p-2 md:p-6`}>
                
                <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                    <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-white/10 rounded-full mix-blend-overlay blur-[80px] animate-blob"></div>
                    <div className="absolute bottom-[-20%] left-[20%] w-[50%] h-[50%] bg-white/10 rounded-full mix-blend-overlay blur-[80px] animate-blob animation-delay-4000"></div>
                </div>

                <div className="w-full max-w-[95%] md:max-w-6xl lg:max-w-7xl glass-card rounded-[2rem] md:rounded-[3rem] overflow-hidden relative z-10 transition-all duration-500 flex flex-col md:flex-row h-auto min-h-[90vh]">
                    
                    {/* 左カラム (PCのみ表示) */}
                    <div className={`${viewMode === 'radar' ? 'hidden' : 'md:w-5/12'} hidden md:flex flex-col justify-center items-center p-8 relative bg-black/5 text-white h-full min-h-[600px] overflow-hidden`}>
                         <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>

                         {weatherData && viewMode === 'weather' && !loading && (
                             <div className="flex flex-col items-center justify-center h-full relative z-10 w-full">
                                <div className="inline-flex items-center space-x-2 bg-black/10 px-5 py-2 rounded-full border border-white/20 backdrop-blur-md shadow-lg mb-8">
                                    <MapPin className="w-5 h-5 text-white" />
                                    <h2 className="text-2xl font-black tracking-widest text-white text-glow">{weatherData.city}</h2>
                                    <div className="w-px h-4 bg-white/30 mx-2"></div>
                                    <button onClick={toggleFavorite} className="focus:outline-none hover:scale-110 transition-transform">
                                        <Star className={`w-5 h-5 ${isFavorite ? "fill-yellow-400 text-yellow-400" : "text-white/60 hover:text-yellow-300"}`} />
                                    </button>
                                </div>
                                
                                <div className="w-40 h-40 lg:w-56 lg:h-56 transform transition-transform hover:scale-110 duration-500 cursor-pointer filter drop-shadow-2xl">
                                    {getWeatherIcon(weatherData.current.weathercode).icon}
                                </div>
                                
                                <div className="relative mt-6 flex flex-col items-center">
                                    <span className="text-xs font-bold text-white/80 uppercase tracking-widest bg-white/10 px-3 py-1 rounded-full mb-2">Current Temp</span>
                                    <h1 className="text-7xl lg:text-9xl font-black tracking-tighter text-white drop-shadow-lg text-glow">
                                    {weatherData.current.temperature}<span className="text-5xl lg:text-6xl align-top absolute -right-8 lg:-right-12">°</span>
                                    </h1>
                                </div>
                                
                                <p className="text-xl lg:text-2xl font-black mt-4 text-white tracking-widest bg-black/10 px-8 py-2 rounded-full shadow-inner backdrop-blur-sm border border-white/10">
                                    {getWeatherIcon(weatherData.current.weathercode).label}
                                </p>

                                <div className="mt-8 flex space-x-12 text-white">
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1 text-red-100 drop-shadow-md">
                                            <ArrowUp className="w-4 h-4" />
                                            <span className="text-xs font-bold uppercase tracking-widest">High</span>
                                        </div>
                                        <span className="text-3xl font-black drop-shadow-lg">{Math.round(weatherData.daily.temperature_2m_max[0])}°</span>
                                    </div>
                                    <div className="w-px h-12 bg-white/20"></div>
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1 text-blue-100 drop-shadow-md">
                                            <ArrowDown className="w-4 h-4" />
                                            <span className="text-xs font-bold uppercase tracking-widest">Low</span>
                                        </div>
                                        <span className="text-3xl font-black drop-shadow-lg">{Math.round(weatherData.daily.temperature_2m_min[0])}°</span>
                                    </div>
                                </div>

                                <div className="mt-8 flex space-x-10 text-white/80">
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1">
                                            <Sunrise className="w-5 h-5 text-orange-300" />
                                            <span className="text-xs font-bold uppercase tracking-widest">Sunrise</span>
                                        </div>
                                        <span className="text-xl font-bold">{formatSunTime(weatherData.daily.sunrise[0])}</span>
                                    </div>
                                    <div className="w-px h-10 bg-white/20"></div>
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1">
                                            <Sunset className="w-5 h-5 text-purple-300" />
                                            <span className="text-xs font-bold uppercase tracking-widest">Sunset</span>
                                        </div>
                                        <span className="text-xl font-bold">{formatSunTime(weatherData.daily.sunset[0])}</span>
                                    </div>
                                </div>
                             </div>
                         )}
                         
                         {!weatherData && (
                             <div className="flex h-full items-center justify-center">
                                 <Sun className="w-32 h-32 text-white/20 animate-spin-slow" />
                             </div>
                         )}
                    </div>

                    {/* 右カラム (メインコンテンツ) */}
                    <div className="flex-1 flex flex-col p-4 md:p-8 overflow-hidden">
                        
                        <div className="mb-6">
                            <form onSubmit={handleSearch} className="relative flex items-center gap-2 md:gap-3 group mb-4">
                                <div className="relative flex-1">
                                    <div className="absolute inset-0 bg-white/30 rounded-full blur-md group-hover:bg-white/50 transition-all duration-300"></div>
                                    <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/70 w-5 h-5 z-20" />
                                    <input
                                        type="text"
                                        placeholder="都市名..."
                                        className="w-full pl-12 pr-4 py-3 rounded-full bg-white/20 border border-white/30 focus:border-white/80 focus:bg-white/30 focus:ring-2 focus:ring-white/50 outline-none text-white placeholder-white/60 transition-all duration-300 shadow-lg backdrop-blur-sm font-bold relative z-10"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <button type="submit" className="bg-white/20 hover:bg-white/40 text-white p-3 rounded-full shadow-lg hover:shadow-white/20 backdrop-blur-md" disabled={loading}>
                                    {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5 stroke-[3px]" />}
                                </button>
                                <button type="button" onClick={handleCurrentLocation} className="bg-white/20 hover:bg-white/40 text-white p-3 rounded-full shadow-lg hover:shadow-white/20 backdrop-blur-md" disabled={loading}>
                                    <LocateFixed className="w-5 h-5 stroke-[3px]" />
                                </button>
                            </form>

                            {favorites.length > 0 && (
                                <div className="flex flex-wrap gap-2 mb-4">
                                {favorites.map(favCity => (
                                    <button
                                    key={favCity}
                                    onClick={() => fetchWeather(favCity)}
                                    className={`flex items-center space-x-1 px-3 py-1.5 rounded-full text-xs font-bold border shadow-sm hover:scale-105 active:scale-95 transition-all
                                        ${city === favCity 
                                        ? 'bg-white text-blue-600 border-white ring-2 ring-white/50' 
                                        : 'bg-black/20 text-white border-white/10 hover:bg-black/30'}`}
                                    >
                                    <Star className={`w-3 h-3 ${city === favCity ? 'fill-blue-500 text-blue-500' : 'text-yellow-300 fill-yellow-300'}`} />
                                    <span>{favCity}</span>
                                    <div onClick={(e) => removeFavorite(e, favCity)} className="ml-1 hover:bg-red-500/80 rounded-full p-0.5 text-white"><X className="w-2.5 h-2.5" /></div>
                                    </button>
                                ))}
                                </div>
                            )}

                            {error && <div className="mb-4 p-3 bg-red-500/20 text-white font-bold rounded-xl text-sm flex items-center animate-bounce">⚠️ {error}</div>}

                            {weatherData && (
                                <div className="flex bg-black/20 p-1 rounded-full border border-white/10 backdrop-blur-md">
                                    <button onClick={() => setViewMode('weather')} className={`flex-1 py-2 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all ${viewMode === 'weather' ? 'bg-white text-blue-600 shadow-md' : 'text-white/70 hover:text-white'}`}>
                                        <Sun className="w-4 h-4" /> 天気予報
                                    </button>
                                    <button onClick={() => setViewMode('radar')} className={`flex-1 py-2 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all ${viewMode === 'radar' ? 'bg-white text-blue-600 shadow-md' : 'text-white/70 hover:text-white'}`}>
                                        <RadarIcon className="w-4 h-4" /> 雨雲レーダー
                                    </button>
                                </div>
                            )}
                        </div>

                        {weatherData && !loading ? (
                            <div className="animate-in fade-in slide-in-from-bottom-8 duration-500 flex-1 overflow-y-auto scrollbar-hide pb-8">
                                {viewMode === 'weather' ? (
                                    /* 天気モード */
                                    <>
                                        {/* 気象アラート表示エリア */}
                                        {currentAlerts.length > 0 && (
                                            <div className="mb-6 space-y-2">
                                                {currentAlerts.map((alert, idx) => (
                                                    <div key={idx} className={`flex items-center p-3 rounded-xl text-white shadow-lg backdrop-blur-md ${alert.color} animate-pulse`}>
                                                        <AlertTriangle className="w-5 h-5 mr-3 flex-shrink-0" />
                                                        <span className="text-sm font-bold">{alert.message}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {/* Mobile Visual Header */}
                                        <div className="md:hidden flex flex-col items-center mb-6 px-4">
                                            <div className="inline-flex items-center space-x-2 bg-black/10 px-4 py-1.5 rounded-full border border-white/20 mb-4">
                                                <MapPin className="w-4 h-4 text-white" />
                                                <h2 className="text-base font-black text-white">{weatherData.city}</h2>
                                                <div className="w-px h-3 bg-white/30 mx-1"></div>
                                                <button onClick={toggleFavorite}><Star className={`w-4 h-4 ${isFavorite ? "fill-yellow-400 text-yellow-400" : "text-white/60"}`} /></button>
                                            </div>
                                            <div className="flex items-center justify-center mb-2">
                                                <div className="w-20 h-20 mr-4 filter drop-shadow-md">{getWeatherIcon(weatherData.current.weathercode).icon}</div>
                                                <div className="flex flex-col">
                                                    <span className="text-[10px] font-bold text-white/80 uppercase tracking-widest text-center">Current</span>
                                                    <h1 className="text-6xl font-black text-white drop-shadow-md leading-none">{weatherData.current.temperature}°</h1>
                                                    <p className="text-sm font-bold text-white/80 text-center">{getWeatherIcon(weatherData.current.weathercode).label}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Stats */}
                                        <div className="grid grid-cols-2 gap-3 mb-6 px-4 md:px-6">
                                            {[
                                                { icon: <Wind className="w-5 h-5" />, label: "風速", value: weatherData.current.windspeed, unit: "km/h", color: "text-blue-200" },
                                                { icon: <Droplets className="w-5 h-5" />, label: "湿度", value: weatherData.current.humidity, unit: "%", color: "text-cyan-200" },
                                                { icon: <User className="w-5 h-5" />, label: "体感", value: Math.round(weatherData.current.apparent_temp), unit: "°", color: "text-orange-200" },
                                                { icon: <Calendar className="w-5 h-5" />, label: "日付", value: new Date().getDate(), unit: "日", color: "text-purple-200" }
                                            ].map((stat, idx) => (
                                                <div key={idx} className="bg-black/10 p-3 rounded-2xl flex flex-col items-center justify-center border border-white/10 hover:bg-black/20 transition-colors">
                                                    <div className={`flex items-center space-x-1 mb-1 ${stat.color}`}>{stat.icon} <span className="text-xs font-bold text-white/70 ml-1">{stat.label}</span></div>
                                                    <span className="text-xl font-black text-white">{stat.value}<span className="text-xs ml-0.5 text-white/60">{stat.unit}</span></span>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Hourly */}
                                        <div className="mb-6 px-4 md:px-6">
                                            <div className="bg-black/10 rounded-3xl p-4 border border-white/10">
                                                <h3 className="text-white/60 text-xs font-black mb-3 flex items-center"><Clock className="w-4 h-4 mr-1 text-blue-300" /> 時間予報</h3>
                                                <div className="flex overflow-x-auto gap-4 pb-2 scrollbar-hide">
                                                    {weatherData.hourly.time.map((t, i) => (
                                                        <div key={i} className="flex flex-col items-center flex-shrink-0 space-y-1">
                                                            <span className="text-xs text-white/70">{formatTimeShort(t)}</span>
                                                            <div className="w-8 h-8">{getWeatherIcon(weatherData.hourly.weathercode[i]).icon}</div>
                                                            <span className="text-sm font-bold text-white">{Math.round(weatherData.hourly.temperature[i])}°</span>
                                                            <div className="text-[10px] text-blue-200 bg-blue-500/20 px-1.5 rounded-full">{weatherData.hourly.precipitation[i]}%</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Daily */}
                                        <div className="px-4 md:px-6">
                                            <div className="bg-black/10 rounded-3xl p-4 border border-white/10">
                                                <h3 className="text-white/60 text-xs font-black mb-3 flex items-center"><Sparkles className="w-4 h-4 mr-1 text-yellow-300" /> 週間予報</h3>
                                                <div className="space-y-3">
                                                    {weatherData.daily.time.slice(1, 8).map((date, index) => {
                                                        const code = weatherData.daily.weather_code[index + 1];
                                                        const iconInfo = getWeatherIcon(code);
                                                        return (
                                                            <div key={date} className="flex items-center justify-between bg-white/5 p-2 rounded-xl border border-white/5">
                                                                <div className="flex items-center w-1/3">
                                                                    <span className="text-xs font-bold text-white bg-black/20 px-2 py-1 rounded mr-2">{new Date(date).toLocaleDateString('ja-JP', { weekday: 'short' })}</span>
                                                                    <div className="w-8 h-8">{React.cloneElement(iconInfo.icon, { className: `w-full h-full ${iconInfo.text}` })}</div>
                                                                </div>
                                                                <div className="text-xs text-white/80 w-1/3 text-center">{iconInfo.label}</div>
                                                                <div className="flex items-center justify-end w-1/3 space-x-3">
                                                                    <div className="text-center">
                                                                        <span className="block font-black text-white text-base leading-none drop-shadow-sm">{Math.round(weatherData.daily.temperature_2m_max[index + 1])}°</span>
                                                                        <span className="text-[9px] text-red-100 font-bold opacity-80">H</span>
                                                                    </div>
                                                                    <div className="w-px h-6 bg-white/20"></div>
                                                                    <div className="text-center">
                                                                        <span className="block font-bold text-white/90 text-base leading-none">{Math.round(weatherData.daily.temperature_2m_min[index + 1])}°</span>
                                                                        <span className="text-[9px] text-blue-100 font-bold opacity-80">L</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Share Button (Bottom of content) */}
                                        <div className="mt-6 mb-8 px-4 flex justify-center">
                                            <button 
                                                onClick={handleShare}
                                                className="group flex items-center space-x-2 bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-full font-bold transition-all shadow-lg active:scale-95 backdrop-blur-md border border-white/20"
                                            >
                                                <Share2 className="w-5 h-5" />
                                                <span>この天気を共有</span>
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    /* レーダーモード */
                                    <div className="h-full min-h-[500px] flex flex-col">
                                        <div className="md:hidden inline-flex items-center justify-center space-x-2 bg-black/10 px-4 py-1.5 rounded-full border border-white/20 backdrop-blur-md shadow-lg mb-4 hover:bg-black/20 transition-colors cursor-default mx-auto">
                                            <MapPin className="w-4 h-4 text-white" />
                                            <h2 className="text-sm font-black tracking-widest text-white text-glow">{weatherData.city} 周辺</h2>
                                        </div>
                                        <div className="flex-1 w-full bg-white/20 rounded-3xl border border-white/20 shadow-inner overflow-hidden relative min-h-[400px]">
                                            <RadarMap lat={coords.lat} lon={coords.lon} />
                                        </div>
                                        <p className="text-white/60 text-[10px] text-center mt-2 font-bold">データ提供: OpenStreetMap, RainViewer</p>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full">
                                {loading ? (
                                    <div className="flex flex-col items-center">
                                        <Loader2 className="w-12 h-12 text-white animate-spin mb-4" />
                                        <p className="text-white font-bold tracking-widest animate-pulse">LOADING...</p>
                                    </div>
                                ) : (
                                    <div className="text-center text-white/50">
                                        <Sun className="w-20 h-20 mx-auto mb-4 opacity-50" />
                                        <p>都市名を入力して天気を検索</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>

                {/* Toast Notification */}
                {shareToast && (
                    <div className="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full flex items-center shadow-2xl backdrop-blur-md animate-slide-up z-50 border border-white/10">
                        <Check className="w-5 h-5 text-green-400 mr-2" />
                        <span className="font-bold text-sm">リンクをコピーしました</span>
                    </div>
                )}

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>