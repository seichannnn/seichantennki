<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§©Ê∞ó‰∫àÂ†±„Ç¢„Éó„É™</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (Âú∞Âõ≥Áî®) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- React, ReactDOM, and Lucide Icons via Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- Leaflet JS (Âú∞Âõ≥Áî®) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Babel for transforming JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        @keyframes gradient-slow {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animate-blob {
          animation: blob 10s infinite;
        }
        .animate-gradient-slow {
          animation: gradient-slow 20s ease infinite;
        }
        /* „Ç´„Éº„Éâ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .glass-card {
           background: rgba(255, 255, 255, 0.4);
           box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
           backdrop-filter: blur(12px);
           -webkit-backdrop-filter: blur(12px);
           border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .text-glow {
            text-shadow: 0 0 10px rgba(255,255,255,0.7);
        }
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÈùûË°®Á§∫ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* LeafletÂú∞Âõ≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .leaflet-container {
            background: rgba(255, 255, 255, 0.5) !important;
            font-family: sans-serif;
            z-index: 0;
        }
        /* „É¨„É≥„Ç∏„Çπ„É©„Ç§„ÉÄ„Éº */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            position: relative;
            z-index: 20;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent;
            border-radius: 2px;
        }
        /* „Éà„Éº„Çπ„ÉàÈÄöÁü•„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes slide-up {
            from { transform: translateY(100%) translateX(-50%); opacity: 0; }
            to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }
        /* Ê≥¢Á¥ã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÈü≥Â£∞ÂÜçÁîüÊôÇÔºâ */
        @keyframes ping-slow {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-ping-slow {
            animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* Èõ®„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà */
        .rain {
            position: absolute;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }
        .rain-drop {
            position: absolute;
            bottom: 100%;
            width: 1px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.5));
            animation: fall linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(100vh); }
        }

        /* Èõ™„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà */
        .snow {
            position: absolute;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }
        .snow-flake {
            position: absolute;
            top: -10px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            to { transform: translateY(100vh) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Wind, MapPin, Calendar, Sun, Cloud, CloudRain, CloudSnow, CloudLightning, CloudFog, Loader2, Thermometer, LocateFixed, Droplets, User, Star, X, Sparkles, Map as MapIcon, CloudRain as RadarIcon, Play, Pause, Umbrella, Sunrise, Sunset, Clock, ArrowUp, ArrowDown, AlertTriangle, Share2, Check, Navigation, Shirt, Activity, Gauge, Eye, Volume2, VolumeX, Mic, MicOff, MessageSquare, Moon, Globe, Layers, Mountain, Settings } from 'lucide-react';

        // --- Â§©ÂÄô„Ç®„Éï„Çß„ÇØ„Éà„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const WeatherEffects = ({ weathercode }) => {
            const isRain = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(weathercode);
            const isSnow = [71, 73, 75, 77, 85, 86].includes(weathercode);

            if (isRain) {
                return (
                    <div className="rain overflow-hidden h-full w-full absolute top-0 left-0">
                        {[...Array(50)].map((_, i) => (
                            <div key={i} className="rain-drop" style={{
                                left: `${Math.random() * 100}%`,
                                animationDuration: `${0.5 + Math.random() * 0.5}s`,
                                animationDelay: `${Math.random() * 2}s`
                            }}></div>
                        ))}
                    </div>
                );
            }
            if (isSnow) {
                return (
                    <div className="snow overflow-hidden h-full w-full absolute top-0 left-0">
                        {[...Array(30)].map((_, i) => (
                            <div key={i} className="snow-flake" style={{
                                left: `${Math.random() * 100}%`,
                                width: `${5 + Math.random() * 5}px`,
                                height: `${5 + Math.random() * 5}px`,
                                animationDuration: `${3 + Math.random() * 5}s`,
                                animationDelay: `${Math.random() * 5}s`
                            }}></div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // --- „Éû„ÉÉ„Éó„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const RadarMap = ({ lat, lon }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const baseLayerRef = useRef(null);
            const radarLayerRef = useRef(null);
            
            const [frames, setFrames] = useState([]); 
            const [currentFrameIndex, setCurrentFrameIndex] = useState(0);
            const [pastCount, setPastCount] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [apiHost, setApiHost] = useState('https://tile.cache.rainviewer.com');
            const [isForecast, setIsForecast] = useState(false);
            
            // Map Settings
            const [baseMap, setBaseMap] = useState('standard'); // standard, satellite, terrain, dark
            const [radarColor, setRadarColor] = useState(1); // 1:Original, 2:Universal Blue, 3:TITAN, 4:TWC, 5:Meteored, 6:NEXRAD, 7:RAINBOW, 8:DarkSky
            const [radarSmooth, setRadarSmooth] = useState(true);
            const [radarSnow, setRadarSnow] = useState(false);
            const [isMenuOpen, setIsMenuOpen] = useState(false);

            useEffect(() => {
                if (!mapRef.current) return;

                // Base Map URLs
                const baseMaps = {
                    standard: { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attr: '&copy; OSM' },
                    satellite: { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attr: 'Tiles &copy; Esri' },
                    terrain: { url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attr: '&copy; OpenTopoMap' },
                    dark: { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', attr: '&copy; CartoDB' }
                };

                const selectedBase = baseMaps[baseMap];

                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current, {
                        center: [lat, lon],
                        zoom: 8,
                        zoomControl: false,
                        attributionControl: false
                    });

                    baseLayerRef.current = L.tileLayer(selectedBase.url, {
                        opacity: baseMap === 'satellite' ? 1.0 : 0.7,
                        attribution: selectedBase.attr
                    }).addTo(mapInstanceRef.current);

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #3b82f6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px #3b82f6;"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    L.marker([lat, lon], { icon }).addTo(mapInstanceRef.current);
                } else {
                    mapInstanceRef.current.setView([lat, lon], 8);
                    
                    if (baseLayerRef.current) {
                        mapInstanceRef.current.removeLayer(baseLayerRef.current);
                    }
                    baseLayerRef.current = L.tileLayer(selectedBase.url, {
                        opacity: baseMap === 'satellite' ? 1.0 : 0.7,
                        attribution: selectedBase.attr
                    }).addTo(mapInstanceRef.current);
                    
                    baseLayerRef.current.bringToBack();
                }
                
                setTimeout(() => {
                    if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                }, 100);

            }, [lat, lon, baseMap]);

            useEffect(() => {
                const fetchRadar = async () => {
                    try {
                        const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                        const data = await response.json();
                        
                        const pastData = data.radar.past || [];
                        const nowcastData = data.radar.nowcast || [];
                        const allFrames = [...pastData, ...nowcastData];
                        
                        setFrames(allFrames);
                        setPastCount(pastData.length);
                        if (data.host) setApiHost(data.host);

                        if (pastData.length > 0) {
                            setCurrentFrameIndex(pastData.length - 1);
                        } else {
                            setCurrentFrameIndex(0);
                        }

                    } catch (error) {
                        console.error("Radar fetch error:", error);
                    }
                };

                fetchRadar();
            }, []);

            useEffect(() => {
                if (!mapInstanceRef.current || frames.length === 0) return;

                const frame = frames[currentFrameIndex];
                if (!frame) return;

                const isFuture = currentFrameIndex >= pastCount;
                setIsForecast(isFuture);

                if (radarLayerRef.current) {
                    mapInstanceRef.current.removeLayer(radarLayerRef.current);
                }

                // RainViewer Options: {color}/{smooth}_{snow}.png
                // smooth: 1 (on), 0 (off)
                // snow: 1 (on), 0 (off)
                const options = `${radarSmooth ? '1' : '0'}_${radarSnow ? '1' : '0'}`;
                const layerUrl = `${apiHost}${frame.path}/256/{z}/{x}/{y}/${radarColor}/${options}.png`;

                radarLayerRef.current = L.tileLayer(layerUrl, {
                    opacity: 0.8,
                    zIndex: 100
                }).addTo(mapInstanceRef.current);

            }, [currentFrameIndex, frames, apiHost, pastCount, radarColor, radarSmooth, radarSnow]);

            useEffect(() => {
                let intervalId;
                if (isPlaying && frames.length > 0) {
                    intervalId = setInterval(() => {
                        setCurrentFrameIndex((prevIndex) => {
                            return (prevIndex + 1) % frames.length;
                        });
                    }, 500);
                }
                return () => clearInterval(intervalId);
            }, [isPlaying, frames.length]);

            const formatTime = (timestamp) => {
                const date = new Date(timestamp * 1000);
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            const togglePlay = () => setIsPlaying(!isPlaying);

            const handleSliderChange = (e) => {
                setIsPlaying(false);
                setCurrentFrameIndex(Number(e.target.value));
            };

            const nowPositionPercent = frames.length > 1 ? ((pastCount - 1) / (frames.length - 1)) * 100 : 0;

            // „Éû„ÉÉ„ÉóË®≠ÂÆö„É°„Éã„É•„Éº
            const MapSettings = () => (
                <div className="absolute top-12 right-2 z-[400] bg-white/90 backdrop-blur-md p-3 rounded-xl shadow-lg border border-gray-200 text-gray-800 text-xs w-48 transition-all animate-in fade-in zoom-in-95 duration-200">
                    <div className="space-y-3">
                        <div>
                            <p className="font-bold mb-1 text-gray-500">Âú∞Âõ≥„ÅÆÁ®ÆÈ°û</p>
                            <div className="grid grid-cols-2 gap-1">
                                <button onClick={() => setBaseMap('standard')} className={`p-1.5 rounded border ${baseMap === 'standard' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-200'}`}>Ê®ôÊ∫ñ</button>
                                <button onClick={() => setBaseMap('satellite')} className={`p-1.5 rounded border ${baseMap === 'satellite' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-200'}`}>Ë°õÊòü</button>
                                <button onClick={() => setBaseMap('terrain')} className={`p-1.5 rounded border ${baseMap === 'terrain' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-200'}`}>Âú∞ÂΩ¢</button>
                                <button onClick={() => setBaseMap('dark')} className={`p-1.5 rounded border ${baseMap === 'dark' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-200'}`}>„ÉÄ„Éº„ÇØ</button>
                            </div>
                        </div>
                        <div>
                            <p className="font-bold mb-1 text-gray-500">„É¨„Éº„ÉÄ„ÉºËâ≤</p>
                            <select value={radarColor} onChange={(e) => setRadarColor(e.target.value)} className="w-full p-1.5 rounded border border-gray-300 bg-white">
                                <option value="1">Ê®ôÊ∫ñ (Original)</option>
                                <option value="2">ÈùíÁ≥ª (Universal Blue)</option>
                                <option value="3">Ê¥æÊâã (TITAN)</option>
                                <option value="4">Â§©Ê∞ó‰∫àÂ†±È¢® (TWC)</option>
                                <option value="6">È´òËß£ÂÉèÂ∫¶È¢® (NEXRAD)</option>
                                <option value="8">„É¢„Éé„ÇØ„É≠ (Dark Sky)</option>
                            </select>
                        </div>
                        <div>
                            <p className="font-bold mb-1 text-gray-500">„Ç™„Éó„Ç∑„Éß„É≥</p>
                            <label className="flex items-center space-x-2 cursor-pointer mb-1">
                                <input type="checkbox" checked={radarSmooth} onChange={(e) => setRadarSmooth(e.target.checked)} className="rounded text-blue-500 focus:ring-blue-500" />
                                <span>„Çπ„É†„Éº„Ç∏„É≥„Ç∞</span>
                            </label>
                            <label className="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" checked={radarSnow} onChange={(e) => setRadarSnow(e.target.checked)} className="rounded text-blue-500 focus:ring-blue-500" />
                                <span>Èõ™„ÇíËâ≤ÂàÜ„Åë</span>
                            </label>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="w-full h-full flex flex-col relative rounded-3xl overflow-hidden bg-white/30 border border-white/20">
                    <div className="flex-1 relative min-h-[400px]">
                        <div ref={mapRef} className="absolute inset-0 w-full h-full z-0" />
                        
                        {/* Ë®≠ÂÆö„Éú„Çø„É≥ */}
                        <div className="absolute top-2 right-2 z-[400]">
                            <button 
                                onClick={() => setIsMenuOpen(!isMenuOpen)}
                                className={`p-2 rounded-full shadow-md transition-colors ${isMenuOpen ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`}
                                title="Âú∞Âõ≥Ë®≠ÂÆö"
                            >
                                <Layers className="w-5 h-5" />
                            </button>
                            {isMenuOpen && <MapSettings />}
                        </div>
                    </div>
                    
                    <div className="bg-white/90 backdrop-blur-md p-3 border-t border-gray-200/50 z-10 relative">
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center space-x-3">
                                <button 
                                    onClick={togglePlay}
                                    className="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors shadow-md active:scale-95"
                                >
                                    {isPlaying ? <Pause className="w-4 h-4 fill-current" /> : <Play className="w-4 h-4 fill-current ml-0.5" />}
                                </button>
                                <div className="text-base font-bold text-gray-700 w-36 tabular-nums">
                                    {frames.length > 0 && formatTime(frames[currentFrameIndex].time)}
                                    {isForecast ? (
                                        <span className="text-xs text-blue-500 ml-2 font-normal bg-blue-100 px-2 py-0.5 rounded-full">‰∫àÂ†±</span>
                                    ) : (
                                        currentFrameIndex === pastCount - 1 && <span className="text-xs text-green-600 ml-2 font-normal bg-green-100 px-2 py-0.5 rounded-full">ÁèæÂú®</span>
                                    )}
                                </div>
                            </div>
                            <span className="text-xs font-bold text-gray-500">RainViewer</span>
                        </div>
                        
                        <div className="relative w-full h-8 flex items-center px-1">
                            {frames.length > 0 && (
                                <div 
                                    className="absolute top-1 bottom-1 w-0.5 bg-green-500/50 z-0 pointer-events-none"
                                    style={{ left: `${nowPositionPercent}%` }}
                                ></div>
                            )}
                            
                            <input 
                                type="range" 
                                min="0" 
                                max={frames.length - 1} 
                                value={currentFrameIndex} 
                                onChange={handleSliderChange}
                                className="w-full h-2 rounded-lg appearance-none cursor-pointer z-10 relative"
                                style={{
                                    background: `linear-gradient(to right, #94a3b8 0%, #94a3b8 ${nowPositionPercent}%, #cbd5e1 ${nowPositionPercent}%, #cbd5e1 100%)`
                                }}
                            />
                        </div>

                        <div className="relative h-4 text-[10px] text-gray-500 w-full mt-[-2px] font-medium">
                            <span className="absolute left-0 top-0">ÈÅéÂéª</span>
                            {frames.length > 0 && (
                                <span 
                                    className="absolute transform -translate-x-1/2 text-green-600 font-bold top-0"
                                    style={{ left: `${nowPositionPercent}%` }}
                                >
                                    ÁèæÂú®
                                </span>
                            )}
                            <span className="absolute right-0 top-0">Êú™Êù•</span>
                        </div>
                    </div>
                </div>
            );
        };

        // Ê∞óÊ∏©„Ç∞„É©„Éï„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà (Ê∞óÊ∏©Êäò„ÇåÁ∑ö„ÅÆ„Åø)
        const TempGraph = ({ hourly }) => {
            if (!hourly || hourly.time.length === 0) return null;

            const temps = hourly.temperature;
            const maxTemp = Math.max(...temps) + 2;
            const minTemp = Math.min(...temps) - 2;
            const range = maxTemp - minTemp || 1;
            // const width = 100; // %
            const height = 60; // px

            const points = temps.map((t, i) => {
                const x = (i / (temps.length - 1)) * 100;
                const y = height - ((t - minTemp) / range) * height;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full h-[60px] relative mt-2 mb-2">
                    <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 100 60">
                        <defs>
                            <linearGradient id="tempGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="rgba(255, 255, 255, 0.8)" />
                                <stop offset="100%" stopColor="rgba(255, 255, 255, 0)" />
                            </linearGradient>
                        </defs>
                        <polyline
                            points={points}
                            fill="none"
                            stroke="rgba(255, 255, 255, 0.8)"
                            strokeWidth="2"
                            vectorEffect="non-scaling-stroke"
                            filter="drop-shadow(0 2px 2px rgba(0,0,0,0.3))"
                        />
                        <polygon
                            points={`0,60 ${points} 100,60`}
                            fill="url(#tempGradient)"
                            opacity="0.3"
                        />
                    </svg>
                </div>
            );
        };

        function App() {
            const [city, setCity] = useState('Êù±‰∫¨');
            const [weatherData, setWeatherData] = useState(null);
            const [airQuality, setAirQuality] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [favorites, setFavorites] = useState([]);
            const [viewMode, setViewMode] = useState('weather');
            const [coords, setCoords] = useState({ lat: 35.6895, lon: 139.6917 });
            const [shareToast, setShareToast] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [isListening, setIsListening] = useState(false);

            const getWeatherIcon = (code) => {
                if (code === 0) return { icon: <Sun className="w-full h-full text-yellow-300 animate-spin-slow drop-shadow-md" />, label: 'Âø´Êô¥', bg: 'from-orange-400 via-amber-300 to-yellow-200', text: 'text-yellow-100' };
                if (code >= 1 && code <= 3) return { icon: <Cloud className="w-full h-full text-white drop-shadow-md" />, label: 'Êô¥„Çå/Êõá„Çä', bg: 'from-blue-400 via-sky-300 to-indigo-100', text: 'text-white' };
                if (code >= 45 && code <= 48) return { icon: <CloudFog className="w-full h-full text-gray-100 drop-shadow-md" />, label: 'Èúß', bg: 'from-gray-600 via-slate-400 to-gray-200', text: 'text-gray-100' };
                if (code >= 51 && code <= 67) return { icon: <CloudRain className="w-full h-full text-blue-200 drop-shadow-md" />, label: 'Èõ®', bg: 'from-blue-800 via-blue-600 to-cyan-500', text: 'text-blue-100' };
                if (code >= 71 && code <= 77) return { icon: <CloudSnow className="w-full h-full text-white drop-shadow-md" />, label: 'Èõ™', bg: 'from-indigo-500 via-purple-400 to-pink-200', text: 'text-white' };
                if (code >= 80 && code <= 82) return { icon: <CloudRain className="w-full h-full text-blue-300 drop-shadow-md" />, label: '„Å´„Çè„ÅãÈõ®', bg: 'from-sky-700 via-blue-500 to-sky-300', text: 'text-sky-100' };
                if (code >= 85 && code <= 86) return { icon: <CloudSnow className="w-full h-full text-white drop-shadow-md" />, label: 'Èõ™', bg: 'from-gray-500 via-gray-300 to-white', text: 'text-gray-100' };
                if (code >= 95 && code <= 99) return { icon: <CloudLightning className="w-full h-full text-yellow-300 drop-shadow-md" />, label: 'Èõ∑Èõ®', bg: 'from-slate-900 via-purple-900 to-slate-700', text: 'text-yellow-200' };
                
                return { icon: <Cloud className="w-full h-full text-gray-200" />, label: '‰∏çÊòé', bg: 'from-blue-400 to-blue-200', text: 'text-white' };
            };

            const getClothingAdvice = (temp) => {
                if (temp >= 25) return { icon: <Shirt className="w-5 h-5" />, label: 'ÂçäË¢ñ' };
                if (temp >= 20) return { icon: <Shirt className="w-5 h-5" />, label: 'Èï∑Ë¢ñ' };
                if (temp >= 15) return { icon: <User className="w-5 h-5" />, label: '„Ç´„Éº„Éá„Ç£„Ç¨„É≥' };
                if (temp >= 10) return { icon: <User className="w-5 h-5" />, label: '„Ç∏„É£„Ç±„ÉÉ„Éà' };
                return { icon: <User className="w-5 h-5" />, label: '„Ç≥„Éº„Éà' };
            };

            const getDailyAdvice = (current) => {
                const { weathercode, temperature, windspeed } = current;
                if (weathercode >= 95) return "Èõ∑„ÅåÈ≥¥„Çä„ÇÑ„Åô„ÅÑ„Åß„Åô„ÄÇÂ§ñÂá∫„ÅØÊéß„Åà„ÇÅ„Å´„ÄÇ";
                if ([51, 53, 55, 61, 63, 65].includes(weathercode)) return "ÂÇò„ÇíÂøò„Çå„Åö„Å´„ÄÇË∂≥ÂÖÉ„Å´Ê≥®ÊÑè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                if (temperature >= 30) return "Ê∞¥ÂàÜË£úÁµ¶„Çí„Åì„Åæ„ÇÅ„Å´„ÄÇÁÜ±‰∏≠Áóá„Å´Ê≥®ÊÑèÔºÅ";
                if (temperature <= 5) return "ÂÜ∑„ÅàËæº„Åø„Åæ„Åô„ÄÇÊöñ„Åã„Åè„Åó„Å¶„ÅäÂá∫„Åã„Åë„Çí„ÄÇ";
                if (windspeed >= 30) return "È¢®„ÅåÂº∑„ÅÑ„Åß„Åô„ÄÇÂ∏ΩÂ≠ê„ÅåÈ£õ„Å∞„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÇ";
                if (weathercode === 0) return "Áµ∂Â•Ω„ÅÆÊ¥óÊøØÊó•Âíå„Åß„ÅôÔºÅÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„Åß„Åô„Å≠„ÄÇ";
                return "Á¥†Êïµ„Å™‰∏ÄÊó•„Çí„ÅäÈÅé„Åî„Åó„Åè„Å†„Åï„ÅÑÔºÅ";
            };

            // ÁîüÊ¥ªÊåáÊï∞ (Life Index) „ÅÆË®àÁÆó
            const getLifeIndices = (current) => {
                const { weathercode, humidity, windspeed, temperature } = current;
                const isRainy = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(weathercode);
                
                // Ê¥óÊøØ
                let laundry = { label: 'OK', color: 'text-green-300', icon: <Sun className="w-4 h-4"/> };
                if (isRainy) laundry = { label: '‰∏çÂèØ', color: 'text-red-300', icon: <CloudRain className="w-4 h-4"/> };
                else if (humidity > 70) laundry = { label: '‰πæ„Åç„Å´„Åè„ÅÑ', color: 'text-yellow-300', icon: <Cloud className="w-4 h-4"/> };

                // ÂÇò
                let umbrella = { label: '‰∏çË¶Å', color: 'text-green-300', icon: <Sun className="w-4 h-4"/> };
                if (isRainy) umbrella = { label: 'ÂøÖË¶Å', color: 'text-red-300', icon: <Umbrella className="w-4 h-4"/> };
                else if (weathercode >= 1 && weathercode <= 3) umbrella = { label: 'Êäò„Çä„Åü„Åü„Åø', color: 'text-yellow-300', icon: <Cloud className="w-4 h-4"/> };

                // ‰πæÁá•ËÇå
                let skin = { label: 'Âø´ÈÅ©', color: 'text-green-300' };
                if (humidity < 30) skin = { label: 'Ë≠¶Êàí', color: 'text-red-300' };
                else if (humidity < 50) skin = { label: 'Ê≥®ÊÑè', color: 'text-yellow-300' };

                return { laundry, umbrella, skin };
            };

            const getMoonPhase = (date) => {
                let year = date.getFullYear();
                let month = date.getMonth() + 1;
                const day = date.getDate();
                let c = 0;
                let e = 0;
                let jd = 0;
                let b = 0;

                if (month < 3) {
                    year--;
                    month += 12;
                }
                month++;
                c = 365.25 * year;
                e = 30.6 * month;
                jd = c + e + day - 694039.09;
                jd /= 29.5305882;
                b = parseInt(jd);
                jd -= b;
                b = Math.round(jd * 8);
                if (b >= 8) b = 0;

                const phases = ['üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò'];
                return phases[b];
            };

            const getAqiLabel = (aqi) => {
                if (aqi <= 50) return { label: 'ËâØ„ÅÑ', color: 'text-green-300' };
                if (aqi <= 100) return { label: 'ÊôÆÈÄö', color: 'text-yellow-300' };
                if (aqi <= 150) return { label: 'ÊïèÊÑü„Å™‰∫∫„ÅØÊ≥®ÊÑè', color: 'text-orange-300' };
                return { label: 'ÊÇ™„ÅÑ', color: 'text-red-300' };
            };

            const getWeatherAlerts = (current) => {
                if (!current) return [];
                const alerts = [];
                const { weathercode, windspeed, temperature } = current;

                if (weathercode === 45 || weathercode === 48) alerts.push({ message: 'ÊøÉÈúßÊ≥®ÊÑè', color: 'bg-gray-600/80' });
                if (weathercode >= 95) alerts.push({ message: 'Èõ∑Ê≥®ÊÑè', color: 'bg-yellow-600/80' });
                if ([65, 67, 81, 82].includes(weathercode)) alerts.push({ message: 'Â§ßÈõ®Ê≥®ÊÑè', color: 'bg-blue-700/80' });
                if ([75, 77, 85, 86].includes(weathercode)) alerts.push({ message: 'Â§ßÈõ™Ê≥®ÊÑè', color: 'bg-cyan-700/80' });
                if (windspeed >= 40) alerts.push({ message: 'Âº∑È¢®Ê≥®ÊÑè', color: 'bg-orange-600/80' });
                if (temperature >= 35) alerts.push({ message: 'ÁåõÊöëË≠¶Êàí', color: 'bg-red-600/80' });
                if (temperature <= 0) alerts.push({ message: 'ÂáçÁµêÊ≥®ÊÑè', color: 'bg-sky-600/80' });

                return alerts;
            };

            const fetchWeather = async (cityName) => {
                setLoading(true);
                setError(null);
                try {
                    const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=ja&format=json`;
                    const geoRes = await fetch(geoUrl);
                    const geoData = await geoRes.json();
                
                    if (!geoData.results || geoData.results.length === 0) throw new Error('Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                
                    const { latitude, longitude, name } = geoData.results[0];
                    await Promise.all([
                        fetchWeatherCommon(latitude, longitude, name),
                        fetchAirQuality(latitude, longitude)
                    ]);
                
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const fetchWeatherByCoords = async (latitude, longitude) => {
                setLoading(true);
                setError(null);
                try {
                    let cityName = 'ÁèæÂú®Âú∞';
                    try {
                        const geoRes = await fetch(
                        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=ja`
                        );
                        const geoData = await geoRes.json();
                        cityName = geoData.city || geoData.locality || geoData.principalSubdivision || 'ÁèæÂú®Âú∞';
                    } catch (e) {
                        console.warn("Âú∞ÂêçÂèñÂæóÂ§±Êïó:", e);
                    }
                    await Promise.all([
                        fetchWeatherCommon(latitude, longitude, cityName),
                        fetchAirQuality(latitude, longitude)
                    ]);
                } catch (err) {
                    setError('Â§©Ê∞ó„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    setLoading(false);
                }
            };

            const fetchAirQuality = async (lat, lon) => {
                try {
                    const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5`;
                    const res = await fetch(url);
                    const data = await res.json();
                    setAirQuality(data.current);
                } catch (e) {
                    console.error("AQI fetch failed", e);
                    setAirQuality(null);
                }
            };

            const fetchWeatherCommon = async (latitude, longitude, cityName) => {
                try {
                    setCoords({ lat: latitude, lon: longitude });

                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl,visibility&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset,uv_index_max&timezone=auto&forecast_days=15`;
                    
                    const weatherRes = await fetch(weatherUrl);
                    const weatherData = await weatherRes.json();

                    if (weatherData.error) throw new Error("API Error: " + weatherData.reason);

                    const currentTimeStr = weatherData.current.time;
                    const currentHourStr = currentTimeStr.slice(0, 13);
                    const hourlyIndex = weatherData.hourly.time.findIndex(t => t.startsWith(currentHourStr));
                    const startIndex = hourlyIndex !== -1 ? hourlyIndex : 0;
                    
                    const hourlySlice = {
                        time: weatherData.hourly.time.slice(startIndex, startIndex + 72),
                        temperature: weatherData.hourly.temperature_2m.slice(startIndex, startIndex + 72),
                        weathercode: weatherData.hourly.weather_code.slice(startIndex, startIndex + 72),
                        precipitation: weatherData.hourly.precipitation_probability.slice(startIndex, startIndex + 72),
                    };

                    setWeatherData({
                        city: cityName,
                        current: {
                            time: weatherData.current.time,
                            weathercode: weatherData.current.weather_code,
                            temperature: weatherData.current.temperature_2m,
                            windspeed: weatherData.current.wind_speed_10m,
                            winddirection: weatherData.current.wind_direction_10m,
                            humidity: weatherData.current.relative_humidity_2m,
                            apparent_temp: weatherData.current.apparent_temperature,
                            pressure: weatherData.current.pressure_msl, 
                            visibility: weatherData.current.visibility 
                        },
                        daily: weatherData.daily,
                        hourly: hourlySlice,
                    });
                    setCity(cityName);
                    
                    localStorage.setItem('weatherAppLastCity', cityName);
                } catch (err) {
                    console.error(err);
                    setError("Â§©Ê∞óÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                } finally {
                    setLoading(false);
                }
            };

            const handleCurrentLocation = () => {
                if (!navigator.geolocation) {
                    setError('‰ΩçÁΩÆÊÉÖÂ†±„Åå‰Ωø„Åà„Åæ„Åõ„Çì');
                    return;
                }
                setLoading(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => { fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude); },
                    (err) => { setLoading(false); setError('‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæóÂ§±Êïó'); }
                );
            };

            const handleVoiceSearch = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    setError("„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'ja-JP';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = (event) => {
                    setIsListening(false);
                    console.error("Speech recognition error", event.error);
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setSearchTerm(transcript);
                    fetchWeather(transcript);
                };

                recognition.start();
            };

            const handleSpeak = () => {
                if (!weatherData) return;
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                    setIsSpeaking(false);
                    return;
                }
                const label = getWeatherIcon(weatherData.current.weathercode).label;
                const temp = Math.round(weatherData.current.temperature);
                const advice = getDailyAdvice(weatherData.current);
                const text = `${weatherData.city}„ÅÆÁèæÂú®„ÅÆÂ§©Ê∞ó„ÅØ„ÄÅ${label}„Åß„Åô„ÄÇÊ∞óÊ∏©„ÅØ${temp}Â∫¶„ÄÇ${advice}`;
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'ja-JP';
                utter.onend = () => setIsSpeaking(false);
                window.speechSynthesis.speak(utter);
                setIsSpeaking(true);
            };

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const cityParam = params.get('city');
                if (cityParam) {
                    fetchWeather(cityParam);
                } else {
                    const savedCity = localStorage.getItem('weatherAppLastCity');
                    fetchWeather(savedCity || 'Tokyo');
                }
                const savedFavorites = localStorage.getItem('weatherAppFavorites');
                if (savedFavorites) setFavorites(JSON.parse(savedFavorites));
            }, []);

            const handleShare = () => {
                if (!weatherData) return;
                const url = new URL(window.location.href);
                url.searchParams.set('city', weatherData.city);
                const textArea = document.createElement("textarea");
                textArea.value = url.toString();
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setShareToast(true);
                    setTimeout(() => setShareToast(false), 3000); 
                } catch (err) { setError('„Ç≥„Éî„ÉºÂ§±Êïó'); }
                document.body.removeChild(textArea);
            };

            const toggleFavorite = () => {
                if (!weatherData) return;
                let newFavorites = favorites.includes(weatherData.city) 
                    ? favorites.filter(c => c !== weatherData.city)
                    : [...favorites, weatherData.city];
                setFavorites(newFavorites);
                localStorage.setItem('weatherAppFavorites', JSON.stringify(newFavorites));
            };

            const removeFavorite = (e, targetCity) => {
                e.stopPropagation();
                const newFavorites = favorites.filter(c => c !== targetCity);
                setFavorites(newFavorites);
                localStorage.setItem('weatherAppFavorites', JSON.stringify(newFavorites));
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (searchTerm.trim()) {
                    fetchWeather(searchTerm);
                    setSearchTerm('');
                }
            };

            const formatTimeShort = (isoString) => {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ja-JP', { hour: 'numeric' });
            };

            const formatSunTime = (isoString) => {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            const getTimeBasedGradient = () => {
                if (!weatherData) return 'from-blue-500 to-cyan-400';
                const current = new Date(weatherData.current.time);
                const sunrise = new Date(weatherData.daily.sunrise[0]);
                const sunset = new Date(weatherData.daily.sunset[0]);
                const diffSunrise = (current - sunrise) / 60000;
                const diffSunset = (current - sunset) / 60000;

                if (Math.abs(diffSunrise) <= 30) return 'from-indigo-600 via-purple-500 to-orange-300';
                const morningEnd = new Date(current);
                morningEnd.setHours(10, 0, 0, 0);
                if (current > sunrise && current < morningEnd) return 'from-sky-400 via-cyan-300 to-yellow-100';
                if (Math.abs(diffSunset) <= 60) return 'from-indigo-900 via-purple-700 to-orange-500';
                if (current > sunset || current < sunrise) return 'from-slate-900 via-purple-900 to-slate-950';
                return 'from-blue-500 to-cyan-400';
            };

            const bgGradient = getTimeBasedGradient();
            const isFavorite = weatherData && favorites.includes(weatherData.city);
            const currentAlerts = weatherData ? getWeatherAlerts(weatherData.current) : [];
            const clothing = weatherData ? getClothingAdvice(weatherData.current.temperature) : null;
            const aqiInfo = airQuality ? getAqiLabel(airQuality.us_aqi) : null;
            const dailyAdvice = weatherData ? getDailyAdvice(weatherData.current) : "";
            const lifeIndices = weatherData ? getLifeIndices(weatherData.current) : null;

            return (
                <div className={`min-h-screen relative overflow-x-hidden bg-gradient-to-br ${bgGradient} bg-[length:400%_400%] animate-gradient-slow transition-all duration-1000 ease-in-out flex flex-col items-center p-2 md:p-6`}>
                
                {/* Weather Effects (Rain/Snow) */}
                {weatherData && <WeatherEffects weathercode={weatherData.current.weathercode} />}

                <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                    <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-white/10 rounded-full mix-blend-overlay blur-[80px] animate-blob"></div>
                    <div className="absolute bottom-[-20%] left-[20%] w-[50%] h-[50%] bg-white/10 rounded-full mix-blend-overlay blur-[80px] animate-blob animation-delay-4000"></div>
                </div>

                <div className="w-full max-w-[95%] md:max-w-6xl lg:max-w-7xl glass-card rounded-[2rem] md:rounded-[3rem] overflow-hidden relative z-10 transition-all duration-500 flex flex-col md:flex-row h-auto min-h-[90vh]">
                    
                    {/* Left Column (PC) */}
                    <div className={`${viewMode === 'radar' ? 'hidden' : 'md:w-5/12'} hidden md:flex flex-col justify-center items-center p-8 relative bg-black/5 text-white h-full min-h-[600px] overflow-hidden`}>
                         <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>

                         {weatherData && viewMode === 'weather' && !loading && (
                             <div className="flex flex-col items-center justify-center h-full relative z-10 w-full">
                                <div className="inline-flex items-center space-x-2 bg-black/10 px-5 py-2 rounded-full border border-white/20 backdrop-blur-md shadow-lg mb-8">
                                    <MapPin className="w-5 h-5 text-white" />
                                    <h2 className="text-2xl font-black tracking-widest text-white text-glow">{weatherData.city}</h2>
                                    <div className="w-px h-4 bg-white/30 mx-2"></div>
                                    <button onClick={toggleFavorite} className="focus:outline-none hover:scale-110 transition-transform">
                                        <Star className={`w-5 h-5 ${isFavorite ? "fill-yellow-400 text-yellow-400" : "text-white/60 hover:text-yellow-300"}`} />
                                    </button>
                                </div>
                                
                                <div className="w-40 h-40 lg:w-56 lg:h-56 transform transition-transform hover:scale-110 duration-500 cursor-pointer filter drop-shadow-2xl">
                                    {getWeatherIcon(weatherData.current.weathercode).icon}
                                </div>
                                
                                <div className="relative mt-6 flex flex-col items-center">
                                    <span className="text-xs font-bold text-white/80 uppercase tracking-widest bg-white/10 px-3 py-1 rounded-full mb-2">Current Temp</span>
                                    <h1 className="text-7xl lg:text-9xl font-black tracking-tighter text-white drop-shadow-lg text-glow">
                                    {weatherData.current.temperature}<span className="text-5xl lg:text-6xl align-top absolute -right-8 lg:-right-12">¬∞</span>
                                    </h1>
                                </div>
                                
                                <p className="text-xl lg:text-2xl font-black mt-4 text-white tracking-widest bg-black/10 px-8 py-2 rounded-full shadow-inner backdrop-blur-sm border border-white/10">
                                    {getWeatherIcon(weatherData.current.weathercode).label}
                                </p>

                                {/* ‰ªäÊó•„ÅÆ„Å≤„Å®„Åì„Å® (PC) */}
                                <div className="mt-6 bg-white/10 px-4 py-2 rounded-xl text-center backdrop-blur-sm">
                                    <span className="text-sm font-bold flex items-center justify-center gap-2"><MessageSquare className="w-4 h-4" /> {dailyAdvice}</span>
                                </div>

                                <div className="mt-8 flex space-x-12 text-white">
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1 text-red-100 drop-shadow-md">
                                            <ArrowUp className="w-4 h-4" />
                                            <span className="text-xs font-bold uppercase tracking-widest">High</span>
                                        </div>
                                        <span className="text-3xl font-black drop-shadow-lg">{Math.round(weatherData.daily.temperature_2m_max[0])}¬∞</span>
                                    </div>
                                    <div className="w-px h-12 bg-white/20"></div>
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1 text-blue-100 drop-shadow-md">
                                            <ArrowDown className="w-4 h-4" />
                                            <span className="text-xs font-bold uppercase tracking-widest">Low</span>
                                        </div>
                                        <span className="text-3xl font-black drop-shadow-lg">{Math.round(weatherData.daily.temperature_2m_min[0])}¬∞</span>
                                    </div>
                                </div>

                                <div className="mt-8 flex space-x-10 text-white/80">
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1">
                                            <Sunrise className="w-5 h-5 text-orange-300" />
                                            <span className="text-xs font-bold uppercase tracking-widest">Sunrise</span>
                                        </div>
                                        <span className="text-xl font-bold">{formatSunTime(weatherData.daily.sunrise[0])}</span>
                                    </div>
                                    <div className="w-px h-10 bg-white/20"></div>
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-1 mb-1">
                                            <Sunset className="w-5 h-5 text-purple-300" />
                                            <span className="text-xs font-bold uppercase tracking-widest">Sunset</span>
                                        </div>
                                        <span className="text-xl font-bold">{formatSunTime(weatherData.daily.sunset[0])}</span>
                                    </div>
                                </div>
                             </div>
                         )}
                         
                         {!weatherData && (
                             <div className="flex h-full items-center justify-center">
                                 <Sun className="w-32 h-32 text-white/20 animate-spin-slow" />
                             </div>
                         )}
                    </div>

                    {/* Right Column */}
                    <div className="flex-1 flex flex-col p-4 md:p-8 overflow-hidden">
                        
                        <div className="mb-6">
                            <form onSubmit={handleSearch} className="relative flex items-center gap-2 md:gap-3 group mb-4">
                                <div className="relative flex-1">
                                    <div className="absolute inset-0 bg-white/30 rounded-full blur-md group-hover:bg-white/50 transition-all duration-300"></div>
                                    <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/70 w-5 h-5 z-20" />
                                    <input
                                        type="text"
                                        placeholder="ÈÉΩÂ∏ÇÂêç..."
                                        className="w-full pl-12 pr-12 py-3 rounded-full bg-white/20 border border-white/30 focus:border-white/80 focus:bg-white/30 focus:ring-2 focus:ring-white/50 outline-none text-white placeholder-white/60 transition-all duration-300 shadow-lg backdrop-blur-sm font-bold relative z-10"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    {/* Èü≥Â£∞Ê§úÁ¥¢„Éú„Çø„É≥ */}
                                    <button 
                                        type="button" 
                                        onClick={handleVoiceSearch} 
                                        className={`absolute right-2 top-1/2 transform -translate-y-1/2 p-2 rounded-full z-20 hover:bg-white/20 transition-colors ${isListening ? 'text-red-400 animate-pulse' : 'text-white/70'}`}
                                    >
                                        <Mic className="w-5 h-5" />
                                    </button>
                                </div>
                                <button type="submit" className="bg-white/20 hover:bg-white/40 text-white p-3 rounded-full shadow-lg hover:shadow-white/20 backdrop-blur-md" disabled={loading}><Loader2 className={`w-5 h-5 ${loading ? 'animate-spin' : 'hidden'}`} /><Search className={`w-5 h-5 stroke-[3px] ${loading ? 'hidden' : ''}`} /></button>
                                <button type="button" onClick={handleCurrentLocation} className="bg-white/20 hover:bg-white/40 text-white p-3 rounded-full shadow-lg hover:shadow-white/20 backdrop-blur-md" disabled={loading}><LocateFixed className="w-5 h-5 stroke-[3px]" /></button>
                            </form>

                            {favorites.length > 0 && (
                                <div className="flex flex-wrap gap-2 mb-4">
                                {favorites.map(favCity => (
                                    <button key={favCity} onClick={() => fetchWeather(favCity)} className={`flex items-center space-x-1 px-3 py-1.5 rounded-full text-xs font-bold border shadow-sm hover:scale-105 active:scale-95 transition-all ${city === favCity ? 'bg-white text-blue-600 border-white ring-2 ring-white/50' : 'bg-black/20 text-white border-white/10 hover:bg-black/30'}`}>
                                    <Star className={`w-3 h-3 ${city === favCity ? 'fill-blue-500 text-blue-500' : 'text-yellow-300 fill-yellow-300'}`} />
                                    <span>{favCity}</span>
                                    <div onClick={(e) => removeFavorite(e, favCity)} className="ml-1 hover:bg-red-500/80 rounded-full p-0.5 text-white"><X className="w-2.5 h-2.5" /></div>
                                    </button>
                                ))}
                                </div>
                            )}

                            {error && <div className="mb-4 p-3 bg-red-500/20 text-white font-bold rounded-xl text-sm flex items-center animate-bounce">‚ö†Ô∏è {error}</div>}

                            {weatherData && (
                                <div className="flex bg-black/20 p-1 rounded-full border border-white/10 backdrop-blur-md">
                                    <button onClick={() => setViewMode('weather')} className={`flex-1 py-2 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all ${viewMode === 'weather' ? 'bg-white text-blue-600 shadow-md' : 'text-white/70 hover:text-white'}`}><Sun className="w-4 h-4" /> Â§©Ê∞ó‰∫àÂ†±</button>
                                    <button onClick={() => setViewMode('radar')} className={`flex-1 py-2 rounded-full text-sm font-bold flex items-center justify-center gap-2 transition-all ${viewMode === 'radar' ? 'bg-white text-blue-600 shadow-md' : 'text-white/70 hover:text-white'}`}><RadarIcon className="w-4 h-4" /> Èõ®Èõ≤„É¨„Éº„ÉÄ„Éº</button>
                                </div>
                            )}
                        </div>

                        {weatherData && !loading ? (
                            <div className="animate-in fade-in slide-in-from-bottom-8 duration-500 flex-1 overflow-y-auto scrollbar-hide pb-8">
                                {viewMode === 'weather' ? (
                                    <>
                                        {/* Alerts */}
                                        {currentAlerts.length > 0 && (
                                            <div className="mb-6 space-y-2">
                                                {currentAlerts.map((alert, idx) => (
                                                    <div key={idx} className={`flex items-center p-3 rounded-xl text-white shadow-lg backdrop-blur-md ${alert.color} animate-pulse`}>
                                                        <AlertTriangle className="w-5 h-5 mr-3 flex-shrink-0" />
                                                        <span className="text-sm font-bold">{alert.message}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {/* Mobile Visual Header */}
                                        <div className="md:hidden flex flex-col items-center mb-6 px-4">
                                            <div className="inline-flex items-center space-x-2 bg-black/10 px-4 py-1.5 rounded-full border border-white/20 mb-4">
                                                <MapPin className="w-4 h-4 text-white" />
                                                <h2 className="text-base font-black text-white">{weatherData.city}</h2>
                                                <div className="w-px h-3 bg-white/30 mx-1"></div>
                                                <button onClick={toggleFavorite}><Star className={`w-4 h-4 ${isFavorite ? "fill-yellow-400 text-yellow-400" : "text-white/60"}`} /></button>
                                            </div>
                                            <div className="flex items-center justify-center mb-2">
                                                <div className="w-20 h-20 mr-4 filter drop-shadow-md">{getWeatherIcon(weatherData.current.weathercode).icon}</div>
                                                <div className="flex flex-col">
                                                    <span className="text-[10px] font-bold text-white/80 uppercase tracking-widest text-center">Current</span>
                                                    <h1 className="text-6xl font-black text-white drop-shadow-md leading-none">{weatherData.current.temperature}¬∞</h1>
                                                    <p className="text-sm font-bold text-white/80 text-center">{getWeatherIcon(weatherData.current.weathercode).label}</p>
                                                </div>
                                            </div>
                                            {/* ‰ªäÊó•„ÅÆ„Å≤„Å®„Åì„Å® (Mobile) */}
                                            <div className="mt-2 bg-white/10 px-4 py-2 rounded-xl text-center backdrop-blur-sm w-full">
                                                <span className="text-xs font-bold flex items-center justify-center gap-2"><MessageSquare className="w-3 h-3" /> {dailyAdvice}</span>
                                            </div>
                                        </div>

                                        {/* Life Index (New) */}
                                        <div className="grid grid-cols-4 gap-2 mb-6 px-4 md:px-6">
                                            {lifeIndices && Object.entries(lifeIndices).map(([key, data]) => (
                                                <div key={key} className="bg-black/10 p-2 rounded-xl flex flex-col items-center justify-center border border-white/10">
                                                    <div className={`mb-1 ${data.color}`}>{data.icon ? data.icon : <Activity className="w-4 h-4" />}</div>
                                                    <span className="text-[10px] text-white/70 font-bold">{key === 'laundry' ? 'Ê¥óÊøØ' : key === 'umbrella' ? 'ÂÇò' : 'ËÇå'}</span>
                                                    <span className="text-xs font-black text-white">{data.label}</span>
                                                </div>
                                            ))}
                                            <div className="bg-black/10 p-2 rounded-xl flex flex-col items-center justify-center border border-white/10">
                                                <div className={`mb-1 ${aqiInfo ? aqiInfo.color : 'text-white'}`}><Activity className="w-4 h-4" /></div>
                                                <span className="text-[10px] text-white/70 font-bold">Á©∫Ê∞ó</span>
                                                <span className="text-xs font-black text-white">{aqiInfo ? aqiInfo.label : '-'}</span>
                                            </div>
                                        </div>

                                        {/* Info Cards (AQI & Clothing) */}
                                        <div className="grid grid-cols-2 gap-3 mb-6 px-4 md:px-6">
                                            <div className="bg-black/10 p-3 rounded-2xl flex flex-col items-center justify-center border border-white/10">
                                                <div className="flex items-center space-x-1 mb-1 text-pink-200">
                                                    <Shirt className="w-5 h-5" /> <span className="text-xs font-bold">ÊúçË£ÖÁõÆÂÆâ</span>
                                                </div>
                                                <span className="text-sm font-bold text-white text-center">{clothing?.label}</span>
                                            </div>
                                            <div className="bg-black/10 p-3 rounded-2xl flex flex-col items-center justify-center border border-white/10">
                                                <div className="flex items-center space-x-1 mb-1 text-green-200">
                                                    <Activity className="w-5 h-5" /> <span className="text-xs font-bold">UVÊåáÊï∞</span>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-white">
                                                        {Math.round(weatherData.daily.uv_index_max[0])}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Stats (Updated with Pressure & Visibility) */}
                                        <div className="grid grid-cols-2 gap-3 mb-6 px-4 md:px-6">
                                            {[
                                                { icon: <Navigation className="w-5 h-5" style={{ transform: `rotate(${weatherData.current.winddirection}deg)` }} />, label: "È¢®Âêë„ÉªÈ¢®ÈÄü", value: weatherData.current.windspeed, unit: "km/h", color: "text-blue-200" },
                                                { icon: <Droplets className="w-5 h-5" />, label: "ÊπøÂ∫¶", value: weatherData.current.humidity, unit: "%", color: "text-cyan-200" },
                                                { icon: <Gauge className="w-5 h-5" />, label: "Ê∞óÂúß", value: Math.round(weatherData.current.pressure), unit: "hPa", color: "text-purple-200" },
                                                { icon: <Eye className="w-5 h-5" />, label: "Ë¶ñÁïå", value: (weatherData.current.visibility / 1000).toFixed(1), unit: "km", color: "text-green-200" }
                                            ].map((stat, idx) => (
                                                <div key={idx} className="bg-black/10 p-3 rounded-2xl flex flex-col items-center justify-center border border-white/10 hover:bg-black/20 transition-colors">
                                                    <div className={`flex items-center space-x-1 mb-1 ${stat.color}`}>{stat.icon} <span className="text-xs font-bold text-white/70 ml-1">{stat.label}</span></div>
                                                    <span className="text-xl font-black text-white">{stat.value}<span className="text-xs ml-0.5 text-white/60">{stat.unit}</span></span>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Hourly Graph (Updated Temp Only with Numbers) */}
                                        <div className="mb-6 px-4 md:px-6">
                                            <div className="bg-black/10 rounded-3xl p-4 border border-white/10">
                                                <h3 className="text-white/60 text-xs font-black mb-3 flex items-center"><Clock className="w-4 h-4 mr-1 text-blue-300" /> 72ÊôÇÈñìÊ∞óÊ∏© & ÈôçÊ∞¥Á¢∫Áéá</h3>
                                                <TempGraph hourly={weatherData.hourly} />
                                                <div className="flex overflow-x-auto gap-4 pb-2 scrollbar-hide mt-2">
                                                    {weatherData.hourly.time.map((t, i) => (
                                                        <div key={i} className="flex flex-col items-center flex-shrink-0 space-y-2 min-w-[3.5rem]">
                                                            <span className="text-[10px] text-white/70">{formatTimeShort(t)}</span>
                                                            <div className="w-8 h-8 transform hover:scale-110 transition-transform">{getWeatherIcon(weatherData.hourly.weathercode[i]).icon}</div>
                                                            <span className="text-sm font-bold text-white">{Math.round(weatherData.hourly.temperature[i])}¬∞</span>
                                                            <div className="flex items-center justify-center bg-blue-500/20 text-blue-200 text-[10px] font-bold px-2 py-0.5 rounded-full">
                                                                <Umbrella className="w-2.5 h-2.5 mr-0.5" />
                                                                {weatherData.hourly.precipitation[i]}%
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Daily */}
                                        <div className="px-4 md:px-6">
                                            <div className="bg-black/10 rounded-3xl p-4 border border-white/10">
                                                <h3 className="text-white/60 text-xs font-black mb-3 flex items-center"><Sparkles className="w-4 h-4 mr-1 text-yellow-300" /> 2ÈÄ±Èñì‰∫àÂ†± (14Êó•Èñì)</h3>
                                                <div className="space-y-3 md:grid md:grid-cols-2 md:gap-3 md:space-y-0">
                                                    {weatherData.daily.time.slice(1, 15).map((date, index) => {
                                                        const code = weatherData.daily.weather_code[index + 1];
                                                        const iconInfo = getWeatherIcon(code);
                                                        // Êó•‰ªò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶ÊúàÈΩ¢„ÇíË®àÁÆó
                                                        const targetDate = new Date(date);
                                                        const moon = getMoonPhase(targetDate);

                                                        return (
                                                            <div key={date} className="flex items-center justify-between bg-white/5 p-2 rounded-xl border border-white/5">
                                                                <div className="flex items-center w-1/3">
                                                                    <span className="text-xs font-bold text-white bg-black/20 px-2 py-1 rounded mr-2">{new Date(date).toLocaleDateString('ja-JP', { weekday: 'short' })}</span>
                                                                    <div className="w-8 h-8">{React.cloneElement(iconInfo.icon, { className: `w-full h-full ${iconInfo.text}` })}</div>
                                                                </div>
                                                                <div className="text-xs text-white/80 w-1/3 text-center flex flex-col items-center">
                                                                    <span>{iconInfo.label}</span>
                                                                    <span className="text-[10px] text-yellow-200 mt-0.5">{moon}</span>
                                                                </div>
                                                                <div className="flex items-center justify-end w-1/3 space-x-3">
                                                                    <div className="text-center">
                                                                        <span className="block font-black text-white text-base leading-none drop-shadow-sm">{Math.round(weatherData.daily.temperature_2m_max[index + 1])}¬∞</span>
                                                                        <span className="text-[9px] text-red-100 font-bold opacity-80">H</span>
                                                                    </div>
                                                                    <div className="w-px h-6 bg-white/20"></div>
                                                                    <div className="text-center">
                                                                        <span className="block font-bold text-white/90 text-base leading-none">{Math.round(weatherData.daily.temperature_2m_min[index + 1])}¬∞</span>
                                                                        <span className="text-[9px] text-blue-100 font-bold opacity-80">L</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mt-6 mb-8 px-4 flex justify-center space-x-4">
                                            <button onClick={handleSpeak} className={`group flex items-center space-x-2 bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-full font-bold transition-all shadow-lg active:scale-95 backdrop-blur-md border border-white/20 ${isSpeaking ? 'ring-2 ring-white animate-pulse' : ''}`}>
                                                {isSpeaking ? <VolumeX className="w-5 h-5" /> : <Volume2 className="w-5 h-5" />}
                                                <span>{isSpeaking ? 'ÂÅúÊ≠¢' : 'Ë™≠„Åø‰∏ä„Åí'}</span>
                                                {isSpeaking && <span className="absolute inset-0 rounded-full bg-white/20 animate-ping-slow"></span>}
                                            </button>
                                            <button onClick={handleShare} className="group flex items-center space-x-2 bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-full font-bold transition-all shadow-lg active:scale-95 backdrop-blur-md border border-white/20">
                                                <Share2 className="w-5 h-5" />
                                                <span>ÂÖ±Êúâ</span>
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    /* „É¨„Éº„ÉÄ„Éº„É¢„Éº„Éâ: È´ò„ÅïÂõ∫ÂÆö„ÅßË°®Á§∫ */
                                    <div className="h-full min-h-[500px] flex flex-col relative">
                                        <div className="md:hidden inline-flex items-center justify-center space-x-2 bg-black/10 px-4 py-1.5 rounded-full border border-white/20 backdrop-blur-md shadow-lg mb-4 hover:bg-black/20 transition-colors cursor-default mx-auto">
                                            <MapPin className="w-4 h-4 text-white" />
                                            <h2 className="text-sm font-black tracking-widest text-white text-glow">{weatherData.city} Âë®Ëæ∫</h2>
                                        </div>
                                        <div className="flex-1 w-full bg-white/20 rounded-3xl border border-white/20 shadow-inner overflow-hidden relative min-h-[400px]">
                                            <RadarMap lat={coords.lat} lon={coords.lon} />
                                        </div>
                                        <p className="text-white/60 text-[10px] text-center mt-2 font-bold">„Éá„Éº„ÇøÊèê‰æõ: OpenStreetMap, RainViewer, Esri</p>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full">
                                {loading ? (
                                    <div className="flex flex-col items-center"><Loader2 className="w-12 h-12 text-white animate-spin mb-4" /><p className="text-white font-bold tracking-widest animate-pulse">LOADING...</p></div>
                                ) : (
                                    <div className="text-center text-white/50"><Sun className="w-20 h-20 mx-auto mb-4 opacity-50" /><p>ÈÉΩÂ∏ÇÂêç„ÇíÂÖ•Âäõ„Åó„Å¶Â§©Ê∞ó„ÇíÊ§úÁ¥¢</p></div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Toast Notification */}
                {shareToast && (
                    <div className="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full flex items-center shadow-2xl backdrop-blur-md animate-slide-up z-50 border border-white/10">
                        <Check className="w-5 h-5 text-green-400 mr-2" /><span className="font-bold text-sm">„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü</span>
                    </div>
                )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>